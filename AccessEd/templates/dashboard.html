<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AccessEd | Intelligence Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ========================================
           DESIGN TOKENS & BASE STYLES
        ======================================== */
        :root {
            /* Default Dark Theme Variables */
            --accent-cyan: #00f2ff;
            --accent-purple: #8a2be2;
            --accent-pink: #ff007a;
            --accent-amber: #ffb800;
            --accent-green: #00ff88;
            --bg-deep: #02040a;
            --panel-bg: rgba(11, 15, 30, 0.94);
            --border-light: rgba(255, 255, 255, 0.12);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.5);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        /* LIGHT THEME OVERRIDES */
        [data-theme="light"] {
            --bg-deep: #f0f4f8;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --border-light: rgba(0, 0, 0, 0.1);
            --text-primary: #0f172a; /* Dark Slate */
            --text-secondary: rgba(0, 0, 0, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* Force Tailwind Text Color Overrides for Light Mode */
        [data-theme="light"] .text-white { color: var(--text-primary) !important; }
        [data-theme="light"] .text-white\/90 { color: rgba(15, 23, 42, 0.9) !important; }
        [data-theme="light"] .text-white\/80 { color: rgba(15, 23, 42, 0.8) !important; }
        [data-theme="light"] .text-white\/60 { color: rgba(15, 23, 42, 0.6) !important; }
        [data-theme="light"] .text-white\/50 { color: rgba(15, 23, 42, 0.5) !important; }
        [data-theme="light"] .text-white\/40 { color: rgba(15, 23, 42, 0.4) !important; }
        [data-theme="light"] .text-white\/30 { color: rgba(15, 23, 42, 0.3) !important; }
        [data-theme="light"] .text-white\/20 { color: rgba(15, 23, 42, 0.2) !important; }
        [data-theme="light"] .border-white\/10 { border-color: rgba(0, 0, 0, 0.1) !important; }
        [data-theme="light"] .border-white\/8 { border-color: rgba(0, 0, 0, 0.08) !important; }
        [data-theme="light"] .bg-white\/5 { background-color: rgba(0, 0, 0, 0.05) !important; }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            outline: none; 
        }
        
        html, body { 
            font-family: 'Inter', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            position: fixed;
            font-size: 13px;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ========================================
           THEME TOGGLE BUTTON
        ======================================== */
        .theme-toggle {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--bg-deep);
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 15px var(--accent-cyan);
        }

        /* ========================================
           ANIMATED BACKGROUND SYSTEM
        ======================================== */
        .mesh-gradient {
            position: fixed; 
            inset: 0;
            background: 
                radial-gradient(at 0% 0%, rgba(0, 242, 255, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 0, 122, 0.12) 0px, transparent 50%),
                radial-gradient(at 50% 50%, rgba(138, 43, 226, 0.08) 0px, transparent 80%),
                radial-gradient(at 0% 100%, rgba(0, 255, 136, 0.1) 0px, transparent 60%);
            z-index: -2;
            animation: gradientShift 20s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .cyber-grid {
            position: fixed; 
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.05) 1.5px, transparent 1.5px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1.5px, transparent 1.5px);
            background-size: 80px 80px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 95%);
            z-index: -1;
            opacity: 0.6;
            animation: gridPulse 4s ease-in-out infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.3; }
        }

        /* ========================================
           LAYOUT GRID SYSTEM
        ======================================== */
        .app-mainframe {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: 90px 1fr;
            height: 100vh;
            width: 100vw;
            padding: 1.2rem;
            gap: 1.2rem;
        }

        .sidebar-zone { grid-row: 1 / 3; grid-column: 1; }
        .header-zone { grid-row: 1; grid-column: 2; }
        .content-zone { grid-row: 2; grid-column: 2; overflow: hidden; position: relative; }

        /* ========================================
           GLASS MORPHISM COMPONENTS
        ======================================== */
        .glass-box {
            background: var(--panel-bg);
            backdrop-filter: blur(50px) saturate(180%);
            border: 1px solid var(--border-light);
            border-radius: 26px;
            box-shadow: 0 20px 60px var(--shadow-color);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .glass-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .glass-box:hover::before {
            left: 100%;
        }

        /* ========================================
           3D SWIPER CAROUSEL
        ======================================== */
        .swiper { 
            width: 100%; 
            height: 100%; 
            padding: 20px 0 40px 0;
        }
        
        .swiper-slide {
            width: 300px !important;
            height: 350px !important;
            transition: all 0.6s cubic-bezier(0.2, 1, 0.2, 1);
            filter: blur(3px) brightness(0.4) saturate(0.5);
            transform: scale(0.8);
        }
        
        .swiper-slide-active { 
            filter: blur(0) brightness(1) saturate(1); 
            transform: scale(1.05); 
            z-index: 10; 
        }

        .swiper-slide-prev,
        .swiper-slide-next {
            filter: blur(1px) brightness(0.6) saturate(0.7);
            transform: scale(0.9);
        }

        /* ========================================
           FEATURE CARDS WITH DYNAMIC EFFECTS
        ======================================== */
        .slide-card {
            height: 100%; 
            width: 100%;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center; 
            padding: 2rem; 
            cursor: pointer;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 35px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Rotating Gradient Border Effect */
        .slide-card::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 35px;
            padding: 2px;
            background: linear-gradient(45deg, transparent, var(--accent-cyan), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s;
        }

        .slide-card:hover::before {
            opacity: 1;
            animation: borderRotate 3s linear infinite;
        }

        @keyframes borderRotate {
            0% { background: linear-gradient(0deg, transparent, var(--accent-cyan), transparent); }
            25% { background: linear-gradient(90deg, transparent, var(--accent-pink), transparent); }
            50% { background: linear-gradient(180deg, transparent, var(--accent-purple), transparent); }
            75% { background: linear-gradient(270deg, transparent, var(--accent-green), transparent); }
            100% { background: linear-gradient(360deg, transparent, var(--accent-cyan), transparent); }
        }

        .slide-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 30px 60px rgba(0, 242, 255, 0.3);
        }

        /* ========================================
           FEATURE ICONS WITH 3D EFFECTS
        ======================================== */
        .feature-icon-wrapper {
            width: 110px; 
            height: 110px;
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.1), rgba(138, 43, 226, 0.1));
            border-radius: 30px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 4rem; 
            margin-bottom: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
        }

        .slide-card:hover .feature-icon-wrapper {
            transform: scale(1.1) rotateY(10deg);
            box-shadow: 0 20px 50px rgba(0, 242, 255, 0.4);
            border-color: var(--accent-cyan);
        }

        .feature-icon-wrapper::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .slide-card:hover .feature-icon-wrapper::after {
            opacity: 1;
        }

        /* ========================================
           STATUS BADGES
        ======================================== */
        .feature-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(10px);
        }

        .status-ready {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
            animation: statusPulse 2s infinite;
        }

        .status-soon {
            background: rgba(255, 184, 0, 0.2);
            color: var(--accent-amber);
            border: 1px solid var(--accent-amber);
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ========================================
           HARDWARE CAMERA VIEWPORTS
        ======================================== */
        .split-layout {
            display: grid;
            grid-template-columns: minmax(320px, 450px) 1fr;
            gap: 2rem;
            height: 100%;
            padding: 0.5rem;
        }

        .camera-port {
            width: 100%;
            aspect-ratio: 1 / 1;
            max-height: 100%;
            border-radius: 35px;
            overflow: hidden;
            border: 4px solid var(--accent-cyan);
            background: #000;
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.3);
            position: relative;
        }

        .camera-port::before {
            content: 'Access LINK';
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            color: var(--accent-cyan);
            z-index: 10;
            letter-spacing: 2px;
        }

        .camera-port img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }

        /* ========================================
   NAVIGATION SIDEBAR
======================================== */
.sidebar-btn {
    padding: 1rem 1.5rem;
    border-radius: 16px;
    transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    color: rgba(255, 255, 255, 0.4);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 1.2px;
    width: 100%;
    margin-bottom: 0.5rem;
    border: 1px solid transparent;
    position: relative;
    overflow: hidden;
}

[data-theme="light"].sidebar-btn {
    color: rgba(0, 0, 0, 0.6); 
}

.sidebar-btn::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 0;
    background: var(--accent-cyan);
    transition: height 0.3s;
}

.sidebar-btn:hover::before {
    height: 60%;
}

.sidebar-btn:hover { 
        background: rgba(255, 255, 255, 0.05); 
        color: white;
        transform: translateX(5px);
    }
    [data-theme="light"] .sidebar-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-primary);
    }

/* -------------------------------- */

.sidebar-btn.active {
    background: rgba(0, 242, 255, 0.15);
    color: var(--accent-cyan);
    border: 1px solid rgba(0, 242, 255, 0.3);
    font-weight: 800;
    box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
}

.sidebar-btn.active::before {
    height: 80%;
}

        /* ========================================
           CHAT INTERFACE
        ======================================== */
        .chat-bubble { 
            padding: 1.5rem 2rem; 
            border-radius: 30px; 
            max-width: 80%; 
            font-size: 13px; 
            line-height: 1.6; 
            animation: slideUp 0.4s ease-out;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .bubble-ai { 
            background: rgba(255, 255, 255, 0.04); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            border-top-left-radius: 4px;
        }

        .bubble-user { 
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.15), rgba(138, 43, 226, 0.15)); 
            border: 1px solid rgba(0, 242, 255, 0.3); 
            border-top-right-radius: 4px; 
            color: white; 
            margin-left: auto;
        }

        /* ========================================
           VOICE CONTROLS
        ======================================== */
        .mic-listening { 
            background: linear-gradient(135deg, var(--accent-pink), var(--accent-purple)) !important; 
            box-shadow: 0 0 40px rgba(255, 0, 122, 0.6) !important; 
            animation: pulseMic 1.5s infinite;
        }

        @keyframes pulseMic { 
            0%, 100% { transform: scale(1); } 
            50% { transform: scale(1.05); } 
        }

        /* ========================================
           ANIMATIONS
        ======================================== */
        .view-anim { 
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* ========================================
           SWIPER NAVIGATION BUTTONS
        ======================================== */
        .swiper-button-next, 
        .swiper-button-prev { 
            color: var(--accent-cyan) !important; 
            background: rgba(0, 242, 255, 0.1);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .swiper-button-next:hover,
        .swiper-button-prev:hover {
            background: rgba(0, 242, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.4);
        }

        .swiper-button-next::after,
        .swiper-button-prev::after {
            font-size: 20px;
            font-weight: 900;
        }

        /* ========================================
           LOADING STATES
        ======================================== */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 242, 255, 0.2);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .typing-indicator {
            display: inline-flex; 
            align-items: center; 
            gap: 6px;
            padding: 1rem 1.5rem; 
            background: rgba(255, 255, 255, 0.04); 
            border-radius: 20px; 
            border-top-left-radius: 4px;
        }

        .dot { 
            width: 8px; 
            height: 8px; 
            background: var(--accent-cyan); 
            border-radius: 50%; 
            animation: bounce 1.4s infinite ease-in-out; 
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce { 
            0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 
            40% { transform: scale(1); opacity: 1; } 
        }

        /* ========================================
           NOTIFICATION TOAST
        ======================================== */
        .toast-notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1.5rem 2rem;
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid;
            z-index: 1000;
            animation: slideUp 0.4s ease-out;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .toast-cyan {
            background: rgba(0, 242, 255, 0.1);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .toast-amber {
            background: rgba(255, 184, 0, 0.1);
            border-color: var(--accent-amber);
            color: var(--accent-amber);
        }
        /* 1. Force Sidebar Buttons to be Dark Grey in Light Mode */
        [data-theme="light"] .sidebar-btn {
            color: #334155 !important; /* Dark Slate Grey */
        }

        /* 2. Force Hover State in Light Mode */
        [data-theme="light"] .sidebar-btn:hover {
            background: rgba(0, 0, 0, 0.05) !important;
            color: #000000 !important; /* Pure Black on Hover */
        }

        /* 3. Force Active State (Selected Item) in Light Mode */
        [data-theme="light"] .sidebar-btn.active {
            background: rgba(0, 242, 255, 0.15) !important;
            color: #008080 !important; /* Dark Cyan/Teal for contrast */
            border-color: rgba(0, 242, 255, 0.5) !important;
        }

        /* 4. Fix the "Soon" Badge text color in Light Mode */
        [data-theme="light"] .sidebar-btn span.bg-amber-500\/20 {
            color: #d97706 !important; /* Dark Amber */
            background: rgba(245, 158, 11, 0.2) !important;
        }
    </style>
</head>
<body>
    <div class="mesh-gradient"></div>
    <div class="cyber-grid"></div>

    <div class="app-mainframe">
        <!-- SIDEBAR -->
        <aside class="sidebar-zone glass-box p-8 flex flex-col">
            <div class="flex items-center gap-4 mb-12 px-2">
                <div class="w-12 h-12 bg-gradient-to-tr from-cyan-400 via-blue-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-xl">
                    <span class="text-white font-black text-xl">A</span>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tighter" style="font-family:'Outfit',sans-serif">
                        Access<span class="text-cyan-400">Ed</span>
                    </h1>
                    <div class="h-1 w-10 bg-gradient-to-r from-cyan-400 to-transparent rounded-full mt-1 opacity-60"></div>
                </div>
            </div>

            <nav id="sidebar-nav" class="flex-1 overflow-y-auto pr-2"></nav>

            <div class="mt-auto space-y-4">
                <div class="p-5 bg-white/5 rounded-[24px] border border-white/8 flex items-center gap-4">
                    <div id="neural-dot" class="w-2.5 h-2.5 rounded-full bg-cyan-400 animate-pulse shadow-[0_0_10px_#00f2ff]"></div>
                    <div>
                        <p class="text-[9px] font-black uppercase text-white/30 tracking-[0.2em]">System</p>
                        <p id="neural-text" class="text-xs font-bold text-white/90">Synchronized</p>
                    </div>
                </div>
                <a href="/logout" class="flex items-center justify-center py-5 rounded-[20px] bg-red-500/10 text-red-500 font-bold text-xs uppercase tracking-widest border border-red-500/15 hover:bg-red-500/20 transition-all">
                    Disconnect
                </a>
            </div>
        </aside>

        <!-- HEADER -->
        <header class="header-zone glass-box px-10 flex items-center justify-between">
    <div>
        <h2 id="page-title" class="text-3xl font-black tracking-tight uppercase" style="font-family:'Outfit',sans-serif">Dashboard</h2>
        <p class="text-white/40 text-[10px] font-bold uppercase tracking-[0.2em] mt-1">
            User: <span class="text-white/80">{{ name }}</span> ‚Ä¢ Mode: <span class="text-cyan-400">{{ disability }}</span>
        </p>
    </div>

    <div class="flex items-center gap-8">
        
        <button onclick="AccessEdApp.toggleTheme()" class="theme-toggle" title="Switch Theme">
            <span id="theme-icon">üåô</span>
        </button>
        <div class="flex flex-col items-end gap-1">
            <span class="text-[9px] font-black text-white/20 uppercase tracking-widest">AI Status</span>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>
                <span class="text-xs font-black text-green-500 uppercase tracking-wider">{{ status }}</span>
            </div>
        </div>
        
        <div class="w-14 h-14 rounded-[20px] bg-gradient-to-br from-cyan-500/30 via-purple-500/30 to-pink-500/30 border-2 border-white/10 flex items-center justify-center font-black text-xl text-cyan-400 shadow-xl">
            {{ name[0]|upper }}
        </div>
    </div>
</header>

        <!-- MAIN CONTENT -->
        <main class="content-zone" id="app-root"></main>
    </div>

    <script>
    const AccessEdApp = {
    state: {
        currentView: 'home',
        isMicListening: false,
        isAudioOn: true,
        isHardwareRunning: false,
        isNavigating: false,
        pollInterval: null,
        userName: "{{ name }}",
        // 1. ADD THEME STATE
        theme: localStorage.getItem('accessEdTheme') || 'dark' 
    },

    menu: [
        // ... (Your existing menu items remain unchanged) ...
        { id: 'home', label: 'Ed Dashboard', icon: 'üè†', status: 'ready', desc: 'Central Command' },
        { id: 'asl', label: 'Sign Transcriber', icon: 'üñêÔ∏è', status: 'ready', desc: 'Real-time ASL Recognition' },
        { id: 'cursor', label: 'Smart Cursor', icon: 'üñ±Ô∏è', status: 'ready', desc: 'Hand-Gesture Mouse Control' },
        { id: 'chat', label: 'Ed AI Assistant', icon: 'ü§ñ', status: 'ready', desc: 'Voice & Text Intelligence' },
        { id: 'airpen', label: 'Air Writing', icon: '‚úèÔ∏è', status: 'soon', desc: 'Write in Air Technology' },
        { id: 'bci', label: 'Brain Control Interface', icon: 'üß†', status: 'soon', desc: 'Direct Neural Interface' }
    ],

    init() {
        // 2. APPLY THEME ON LOAD
        this.applyTheme();

        this.renderSidebar();
        
        if (document.readyState === 'complete') {
            this.navigate('home');
        } else {
            window.addEventListener('load', () => {
                setTimeout(() => this.navigate('home'), 100);
            });
        }
    },

    // 3. ADD THEME FUNCTIONS
    toggleTheme() {
        this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('accessEdTheme', this.state.theme);
        this.applyTheme();
    },

    applyTheme() {
        // Set data attribute on HTML tag for CSS logic
        document.documentElement.setAttribute('data-theme', this.state.theme);
        
        // Update Icon
        const icon = document.getElementById('theme-icon');
        if(icon) {
            icon.textContent = this.state.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
    },

        renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            nav.innerHTML = this.menu.map(item => `
                <button onclick="AccessEdApp.navigate('${item.id}')" 
                    class="sidebar-btn ${this.state.currentView === item.id ? 'active' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="text-lg">${item.icon}</span>
                        <span>${item.label}</span>
                    </div>
                    ${item.status === 'soon' ? '<span class="px-2 py-1 bg-amber-500/20 text-amber-400 text-[8px] font-black rounded-lg border border-amber-500/30">SOON</span>' : ''}
                </button>
            `).join('');
        },

        // --- NEW ROBUST HARDWARE STOPPER ---
        async stopHardware() {
            console.log('[SYSTEM] Stopping Hardware...');
            
            // 1. Clear any data polling
            if (this.state.pollInterval) {
                clearInterval(this.state.pollInterval);
                this.state.pollInterval = null;
            }

            // 2. Break the video connection on the frontend
            const aslImg = document.getElementById('asl-stream');
            const cursorImg = document.getElementById('mouse-stream');
            if (aslImg) aslImg.src = "";
            if (cursorImg) cursorImg.src = "";

            // 3. Tell server to release resources
            if (this.state.isHardwareRunning) {
                try {
                    // Send stop requests in parallel
                    await Promise.all([
                        fetch('/stop/asl'),
                        fetch('/stop/cursor')
                    ]);
                    console.log('[SYSTEM] Server stop signals sent');
                } catch (e) {
                    console.warn('Stop signal error:', e);
                }
                this.state.isHardwareRunning = false;
            }
            
            // 4. Force wait for camera release (Critical for Windows)
            await new Promise(r => setTimeout(r, 800));
        },

        async navigate(id) {
            if (this.state.isNavigating || this.state.currentView === id) return;
            
            const target = this.menu.find(m => m.id === id);
            if (target.status === 'soon') {
                this.notify("üîí Feature under development", "amber");
                return;
            }

            this.state.isNavigating = true;
            
            // Visual feedback immediately
            const sidebar = document.getElementById('sidebar-nav');
            sidebar.style.pointerEvents = 'none';
            sidebar.style.opacity = '0.5';

            // Stop any running hardware before switching
            await this.stopHardware();

            this.state.currentView = id;
            this.renderSidebar();
            document.getElementById('page-title').textContent = target.label.toUpperCase();
            
            const root = document.getElementById('app-root');
            
            // Render Loading State
            root.innerHTML = `
                <div class="flex items-center justify-center h-full view-anim">
                    <div class="text-center">
                        <div class="loading-spinner mb-4 mx-auto"></div>
                        <p class="text-white/60 text-sm tracking-widest uppercase">Initializing ${target.label}...</p>
                    </div>
                </div>`;

            // Allow UI to update
            await new Promise(resolve => requestAnimationFrame(resolve));

            try {
                switch(id) {
                    case 'home': this.renderHome(root); break;
                    case 'asl': await this.renderASL(root); break;
                    case 'cursor': await this.renderCursor(root); break;
                    case 'chat': this.renderChat(root); break;
                }
            } catch (error) {
                console.error(`[NAVIGATE] Error rendering ${id}:`, error);
                this.renderError(root, error.message);
            } finally {
                this.state.isNavigating = false;
                sidebar.style.pointerEvents = 'auto';
                sidebar.style.opacity = '1';
            }
        },

        renderError(el, msg) {
            el.innerHTML = `
                <div class="flex items-center justify-center h-full view-anim">
                    <div class="glass-box p-12 max-w-md text-center border-red-500/30">
                        <span class="text-6xl mb-4 block">‚ö†Ô∏è</span>
                        <h3 class="text-2xl font-bold text-red-400 mb-4">System Error</h3>
                        <p class="text-white/60 mb-8 font-mono text-xs">${msg || 'Unknown error occurred'}</p>
                        <button onclick="AccessEdApp.navigate('home')" 
                                class="px-8 py-3 bg-red-500/20 text-red-400 font-bold rounded-xl border border-red-500/50 hover:bg-red-500/30 transition-all uppercase tracking-wider text-xs">
                            Return to Dashboard
                        </button>
                    </div>
                </div>`;
        },

        renderHome(el) {
            el.innerHTML = `
            <div class="h-full flex flex-col gap-6 view-anim">
                <div class="glass-box p-12 bg-gradient-to-br from-cyan-600/10 via-purple-600/5 to-transparent border-white/8 text-center flex-shrink-0">
                    <h3 class="text-6xl font-black mb-4 tracking-tighter uppercase bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent" style="font-family:'Outfit',sans-serif">
                        Hello, ${this.state.userName}
                    </h3>
                    <p class="text-xl text-white/50 font-light max-w-3xl mx-auto leading-relaxed">
                        AccessEd System Online. Ready for input.
                    </p>
                </div>

                <div class="swiper mainSlider flex-1 w-full overflow-hidden" style="min-width: 0;">
                    <div class="swiper-wrapper">
                        ${this.menu.filter(i => i.id !== 'home').map(item => `
                        <div class="swiper-slide">
                            <div onclick="AccessEdApp.navigate('${item.id}')" class="slide-card glass-box cursor-pointer hover:border-cyan-500/30 transition-all">
                                <span class="feature-status status-${item.status}">${item.status === 'ready' ? '‚óè ONLINE' : '‚óè LOCKED'}</span>
                                <div class="feature-icon-wrapper">${item.icon}</div>
                                <h4 class="text-2xl font-black uppercase mb-2 text-white" style="font-family:'Outfit',sans-serif">${item.label}</h4>
                                <p class="text-[11px] text-white/40 font-semibold uppercase tracking-wider leading-relaxed px-4">
                                    ${item.desc}
                                </p>
                            </div>
                        </div>`).join('')}
                    </div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                </div>
            </div>`;

            // ROBUST INIT: Checks if library exists and element is visible
            const initSwiperSafe = (attempts = 0) => {
                const sliderEl = el.querySelector(".mainSlider");

                // Stop if element is gone (user navigated away)
                if (!sliderEl) return;

                // Check 1: Is Swiper library loaded?
                // Check 2: Does the element have width? (Visible on screen)
                if (typeof Swiper === 'undefined' || sliderEl.clientWidth === 0) {
                    if (attempts < 20) { // Try for 2 seconds max
                        setTimeout(() => initSwiperSafe(attempts + 1), 100);
                    }
                    return;
                }

                // If a swiper instance already exists, kill it cleanly
                if (sliderEl.swiper) sliderEl.swiper.destroy(true, true);

                try {
                    new Swiper(sliderEl, {
                        effect: "coverflow",
                        grabCursor: true,
                        centeredSlides: true,
                        slidesPerView: "auto",
                        observer: true, 
                        observeParents: true,
                        coverflowEffect: { 
                            rotate: 25, 
                            stretch: 0, 
                            depth: 300, 
                            modifier: 1, 
                            slideShadows: true 
                        },
                        navigation: { 
                            nextEl: ".swiper-button-next", 
                            prevEl: ".swiper-button-prev" 
                        }
                    });
                } catch (e) {
                    console.error("Swiper init error:", e);
                }
            };

            // Start the safe initialization
            initSwiperSafe();
        },

        async renderASL(el) {
            // 1. Launch Hardware
            console.log('[ASL] Sending launch command...');
            const response = await fetch('/launch/asl');
            const data = await response.json();
            
            if (data.status !== 'started') throw new Error('Hardware handshake failed');
            
            this.state.isHardwareRunning = true;

            // 2. Render Interface
            el.innerHTML = `
            <div class="split-layout view-anim h-full">
                <div class="camera-port relative bg-black rounded-3xl overflow-hidden border border-white/10 shadow-2xl">
                     <img src="/video_feed/asl?t=${Date.now()}" id="asl-stream" class="w-full h-full object-cover">
                    <div class="absolute top-4 left-4 px-3 py-1 bg-red-600 rounded text-[10px] font-bold text-white uppercase tracking-widest animate-pulse">‚óè Live Feed</div>
                </div>
                <div class="glass-box flex flex-col items-center justify-center p-12 text-center border-white/10 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-purple-600"></div>
                    <span class="text-xs font-black text-cyan-400 uppercase tracking-[0.5em] mb-10">Neural Analysis</span>
                    
                    <div id="asl-val" class="text-9xl font-black uppercase tracking-tighter mb-6 transition-all duration-300 scale-100" 
                         style="font-family:'Outfit',sans-serif; text-shadow:0 0 50px rgba(0,242,255,0.3)">...</div>
                    
                    <div class="w-full max-w-sm mt-12 bg-white/5 h-2 rounded-full overflow-hidden">
                        <div id="asl-bar" class="h-full bg-gradient-to-r from-cyan-400 to-purple-500 transition-all duration-300" style="width:0%"></div>
                    </div>
                    <p class="text-[10px] text-white/30 font-bold uppercase tracking-widest mt-4">Confidence Metric</p>
                    
                    <button onclick="AccessEdApp.navigate('home')" class="mt-auto px-10 py-4 bg-red-500/10 text-red-500 font-bold text-xs uppercase tracking-widest rounded-2xl border border-red-500/20 hover:bg-red-500/25 transition-all">
                        End Session
                    </button>
                </div>
            </div>`;

            // 3. Start Polling for Data
            this.state.pollInterval = setInterval(() => {
                fetch('/asl/label')
                    .then(r => r.json())
                    .then(d => {
                        const out = document.getElementById('asl-val');
                        const bar = document.getElementById('asl-bar');
                        if (out) {
                            out.textContent = d.label || '...';
                            // Visual pop effect on change
                            if(out.dataset.last !== d.label) {
                                out.style.transform = "scale(1.1)";
                                setTimeout(() => out.style.transform = "scale(1)", 100);
                            }
                            out.dataset.last = d.label;
                        }
                        if (bar) bar.style.width = ((d.confidence || 0) * 100) + '%';
                    })
                    .catch(console.warn);
            }, 200); // Fast polling for snappy UI
        },

        async renderCursor(el) {
            console.log('[CURSOR] Sending launch command...');
            const response = await fetch('/launch/cursor');
            const data = await response.json();
            
            if (data.status !== 'started') throw new Error('Cursor hardware failed');
            
            this.state.isHardwareRunning = true;

            el.innerHTML = `
            <div class="split-layout view-anim h-full">
                <div class="camera-port relative bg-black rounded-3xl overflow-hidden border border-white/10 shadow-2xl">
                    <img src="/video_feed/cursor?t=${Date.now()}" id="mouse-stream" class="w-full h-full object-cover">
                    <div class="absolute top-4 left-4 px-3 py-1 bg-green-500 rounded text-[10px] font-bold text-black uppercase tracking-widest">‚óè Tracking Active</div>
                </div>
                <div class="glass-box p-12 flex flex-col justify-center border-white/10">
                    <h4 class="text-3xl font-black uppercase mb-12 tracking-tight text-cyan-400 text-center" style="font-family:'Outfit',sans-serif">
                        Gesture Link
                    </h4>
                    
                    <div class="space-y-4">
                        <div class="p-6 bg-white/5 rounded-2xl border border-white/5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center text-cyan-400">‚òùÔ∏è</div>
                            <div>
                                <span class="font-bold block text-sm">Index Finger</span>
                                <span class="text-xs text-white/40">Controls Cursor Position</span>
                            </div>
                        </div>
                        
                        <div class="p-6 bg-white/5 rounded-2xl border border-white/5 flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-pink-500/20 flex items-center justify-center text-pink-400">üëå</div>
                            <div>
                                <span class="font-bold block text-sm">Pinch (Index+Thumb)</span>
                                <span class="text-xs text-white/40">Performs Left Click</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl text-center">
                        <p class="text-[10px] text-amber-300 uppercase tracking-wide font-bold">
                            ‚ö†Ô∏è Ensure hand is visible in camera frame
                        </p>
                    </div>
                    
                    <button onclick="AccessEdApp.navigate('home')" class="mt-auto w-full py-4 bg-red-500/10 text-red-500 font-bold text-xs uppercase tracking-widest rounded-xl border border-red-500/20 hover:bg-red-500/25 transition-all">
                        Deactivate
                    </button>
                </div>
            </div>`;
        },

        renderChat(el) {
            el.innerHTML = `
            <div class="max-w-4xl mx-auto h-full glass-box flex flex-col overflow-hidden view-anim border-white/5">
                <div class="p-6 border-b border-white/5 bg-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-600 rounded-xl flex items-center justify-center text-xl shadow-lg shadow-pink-500/20">ü§ñ</div>
                        <div>
                            <span class="font-black text-sm block tracking-wide" style="font-family:'Outfit',sans-serif">Access Ed AI</span>
                            <span id="neural-text" class="text-[10px] text-green-400 font-mono uppercase">‚óè System Ready</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="AccessEdApp.toggleAudio()" id="btn-audio" class="px-4 py-2 bg-white/5 rounded-lg text-[10px] font-black uppercase border border-white/10 hover:bg-white/10 transition-all">üîä ON</button>
                    </div>
                </div>
                
                <div id="chat-logs" class="flex-1 p-8 overflow-y-auto space-y-6 scrollbar-hide">
                    <div class="flex gap-4 view-anim">
                        <div class="w-8 h-8 rounded-lg bg-pink-500/20 text-pink-400 flex-shrink-0 flex items-center justify-center font-black text-[10px] border border-pink-500/30">AI</div>
                        <div class="chat-bubble bubble-ai shadow-2xl text-sm">
                            Hello ${this.state.userName}! I am ready to assist. Use the microphone or type below.
                        </div>
                    </div>
                </div>
                
                <div class="p-6 bg-black/40 border-t border-white/5 flex gap-3 relative">
                    <button onclick="AccessEdApp.triggerMic()" id="btn-mic" 
                        class="w-12 h-12 rounded-xl bg-pink-600 text-white flex items-center justify-center shadow-lg shadow-pink-600/20 hover:scale-105 transition-all">
                        üéôÔ∏è
                    </button>
                    <input type="text" id="chat-input" placeholder="Type command..." 
                        class="flex-1 bg-white/5 border border-white/10 rounded-xl px-6 text-sm text-white outline-none focus:border-cyan-500/50 transition-all font-medium"
                        onkeypress="if(event.key === 'Enter') AccessEdApp.sendChat()">
                    <button onclick="AccessEdApp.sendChat()" 
                        class="px-6 bg-cyan-500 text-black font-black uppercase text-xs rounded-xl hover:bg-cyan-400 shadow-lg shadow-cyan-500/20 transition-all">
                        SEND
                    </button>
                </div>
            </div>`;
        },

        triggerMic() {
            if (this.state.isMicListening) return;
            this.state.isMicListening = true;
            
            const btn = document.getElementById('btn-mic');
            const status = document.getElementById('neural-text');

            btn.classList.add('animate-pulse', 'bg-red-500');
            status.textContent = "‚óè LISTENING...";
            status.style.color = "#ef4444";

            fetch('/chat/listen', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    this.state.isMicListening = false;
                    btn.classList.remove('animate-pulse', 'bg-red-500');
                    status.textContent = "‚óè PROCESSING";
                    status.style.color = "#eab308";

                    if (data.status === 'success') {
                        document.getElementById('chat-input').value = data.text;
                        this.sendChat();
                    } else {
                        this.notify("Audio capture failed", "red");
                        status.textContent = "‚óè READY";
                        status.style.color = "#4ade80";
                    }
                })
                .catch(() => {
                    this.state.isMicListening = false;
                    btn.classList.remove('animate-pulse', 'bg-red-500');
                    this.notify("Server connection error", "red");
                });
        },

        toggleAudio() {
            this.state.isAudioOn = !this.state.isAudioOn;
            document.getElementById('btn-audio').textContent = this.state.isAudioOn ? "üîä ON" : "üîá OFF";
            document.getElementById('btn-audio').className = this.state.isAudioOn ? 
                "px-4 py-2 bg-white/5 rounded-lg text-[10px] font-black uppercase border border-white/10 hover:bg-white/10 transition-all" :
                "px-4 py-2 bg-red-500/10 text-red-500 rounded-lg text-[10px] font-black uppercase border border-red-500/20 hover:bg-red-500/20 transition-all";
        },

        sendChat() {
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            if (!val) return;
            
            const logs = document.getElementById('chat-logs');
            const status = document.getElementById('neural-text');
            
            // User Bubble
            logs.innerHTML += `<div class="flex justify-end view-anim"><div class="chat-bubble bubble-user shadow-lg text-sm">${val}</div></div>`;
            
            // Loading Bubble
            const loadingId = 'loading-' + Date.now();
            logs.innerHTML += `
                <div id="${loadingId}" class="flex gap-4 view-anim">
                    <div class="w-8 h-8 rounded-lg bg-pink-500/20 text-pink-400 flex-shrink-0 flex items-center justify-center font-black text-[10px] border border-pink-500/30">AI</div>
                    <div class="flex items-center h-10 gap-1 px-4 bg-white/5 rounded-2xl rounded-tl-none">
                        <div class="w-1.5 h-1.5 bg-white/40 rounded-full animate-bounce"></div>
                        <div class="w-1.5 h-1.5 bg-white/40 rounded-full animate-bounce delay-75"></div>
                        <div class="w-1.5 h-1.5 bg-white/40 rounded-full animate-bounce delay-150"></div>
                    </div>
                </div>`;

            input.value = '';
            logs.scrollTop = logs.scrollHeight;
            status.textContent = "‚óè GENERATING...";

            fetch('/chat/send', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ message: val }) 
            }).then(r => r.json()).then(data => {
                document.getElementById(loadingId).remove();
                logs.innerHTML += `
                    <div class="flex gap-4 view-anim">
                        <div class="w-8 h-8 rounded-lg bg-pink-500/20 text-pink-400 flex-shrink-0 flex items-center justify-center font-black text-[10px] border border-pink-500/30">AI</div>
                        <div class="chat-bubble bubble-ai shadow-2xl text-sm">${data.response}</div>
                    </div>`;
                logs.scrollTop = logs.scrollHeight;
                status.textContent = "‚óè READY";
                status.style.color = "#4ade80";
                
                if (this.state.isAudioOn) {
                    fetch('/chat/speak', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ text: data.response }) 
                    });
                }
            });
        },

        notify(msg, color = "cyan") {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-8 right-8 px-6 py-4 bg-[#1a1a1a] border border-${color}-500/30 rounded-xl shadow-2xl flex items-center gap-3 view-anim z-50`;
            toast.innerHTML = `<div class="w-2 h-2 rounded-full bg-${color}-500"></div><span class="font-bold text-xs uppercase tracking-wider" style="color: #ffffff !important;">${msg}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    };

    document.addEventListener('DOMContentLoaded', () => AccessEdApp.init());
</script>
</body>
</html>